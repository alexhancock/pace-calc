<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<dom-module id="pace-calc">
  <template>
    <style is="custom-style" include="iron-flex iron-flex-alignment">
      div {
        color: green;
      }
      label, input {
        display: block;
      }
      input.mini {
        width: 30px;
        margin: 0 auto;
      }
      .top {
        width: 100vw;
        height: 315px;
      }
      .main_fields {
        width: 400px;
        padding-left: 10px;
      }
      .labels {
        width: 100px;
        text-align: center;
        background: black;
        color: white;
      }
      .labels .item {
        height: 100px;
        line-height: 100px;
        width: 100px;
        text-align: center;
        background: black;
        color: white;
      }
      .field {
        height: 100px;
      }
      .forminput {
        width: 150px;
      }
      .time-input-container {
        width: 50px;
        text-align: center;
      }
    </style>
    <div class="top layout horizontal">
      <span class="flex"></span>
      <div class="layout vertical labels center">
        <span class="item">Time</span>
        <span class="item">Distance</span>
        <span class="item">Pace</span>
      </div>
      <div class="layout vertical main_fields">
        <div class="layout horizontal center">
          <form id="time-form" class="layout horizontal center field">
            <div class="time-input-container">
              <span>HH</label>
              <input name="hh" class="mini"></input>
            </div>
            <div class="time-input-container">
              <span>MM</label>
              <input name="mm" class="mini"></input>
            </div>
            <div class="time-input-container">
              <span>SS</label>
              <input name="ss" class="mini"></input>
            </div>
          </form>
          <span class="flex"></span>
          <button id="time-button">Calculate</button>
        </div>
        <div class="layout horizontal center">
          <form id="distance-form" class="layout horizontal center field">
            <div>
              <input class="forminput" type="text" name="value" placeholder="10"></input>
              <select class="forminput">
                <option val="mile">mile</option>
                <option val="km">km</option>
              </select>
            </div>
          </form>
          <span class="flex"></span>
          <button id="distance-button">Calculate</button>
        </div>
        <div class="layout horizontal center">
          <form id="pace-form" class="layout vertical center">
            <div class="layout horizontal center field">
              <div class="time-input-container">
                <span>MM</label>
                <input name="mm" class="mini"></input>
              </div>
              <div class="time-input-container">
                <span>SS</label>
                <input name="ss" class="mini"></input>
              </div>
            </div>
            <div>
              <span>Per</label>
              <select>
                <option val="mile">mile</option>
                <option val="km">km</option>
              </select>
            </div>
          </form>
          <span class="flex"></span>
          <button id="pace-button">Calculate</button>
          <script type="text/javascript">
            // Type diagram
            // time -> { hours: DD, minutes: DD, seconds: DD  }
            // distance -> { value: DD, unit: miles/km }
            // pace -> { minutes: DD, seconds: DD, unit: miles/km }

            // Calculation Logic

            var getSecondsFromTimeObject = function(time){
              var numSecondsFromHours = 0;
              var numSecondsFromMinutes = 0;

              var secondsInMinute = 60;
              var secondsInHour = secondsInMinute * 60;

              if (time.hours){
                numSecondsFromHours = time.hours * secondsInHour;
              }

              if (time.minutes){
                numSecondsFromMinutes = time.minutes * secondsInMinute;
              }

              return numSecondsFromHours + numSecondsFromMinutes + time.seconds;
            };

            var getSecondsFromPaceObject = function(pace){
              var numSecondsFromMinutes;
              if (pace.minutes){
                numSecondsInMinutes = pace.minutes * 60;
              } else {
                numSecondsInMinutes = 0;
              }
              return numSecondsInMinutes + pace.seconds
            };

            var getTimeObjectFromSeconds = function(seconds){
              var hours = 0;
              var minutes = 0;
              var remainingSeconds = seconds;

              var secondsInMinute = 60;
              var secondsInHour = secondsInMinute * 60;

              if (remainingSeconds >= secondsInHour){
                hours = Math.floor(remainingSeconds / secondsInHour);
                remainingSeconds = remainingSeconds % secondsInHour;
              }

              if (remainingSeconds >= secondsInMinute){
                minutes = Math.floor(remainingSeconds / secondsInMinute);
                remainingSeconds = remainingSeconds % secondsInMinute;
              }

              return {
                hours: hours,
                minutes: minutes,
                seconds: remainingSeconds
              }
            };

            var calculateTimeFromDistanceAndPace = function(distance, pace){
              var secondsPerUnitOfDistance = getSecondsFromPaceObject(pace);
              var totalSeconds = secondsPerUnitOfDistance * distance.value;
              return getTimeObjectFromSeconds(totalSeconds);
            };
            var calculateDistanceFromTimeAndPace = function(time, pace){
              var totalSeconds = getSecondsFromTimeObject(time);
              var secondsPerUnitOfDistance = getSecondsFromPaceObject(pace);

              var value = totalSeconds / secondsPerUnitOfDistance;
              var unit = pace.unit;

              return {
                value: value,
                unit: unit
              };
            }
            var calculatePaceFromTimeAndDistance = function(time, distance){}

            // DOM parsing/data retrieval logic

            // TODO - Input validation (check number of seconds for < 60 etc)

            var getPaceObjectFromPaceForm = function(){
              var form = document.getElementById("pace-form");
              var minutes = parseInt(form.querySelector("[name=mm]").value);
              var seconds = parseInt(form.querySelector("[name=ss]").value);
              var unit = form.querySelector("select").value;

              if (minutes === NaN || seconds === NaN || !unit){
                return false;
              }

              return {
                minutes: minutes,
                seconds: seconds,
                unit: unit
              };
            };

            var getDistanceObjectFromDistanceForm = function(){
              var form = document.getElementById("distance-form");
              var value = parseFloat(form.querySelector("[name=value]").value);
              var unit = form.querySelector("select").value;

              if (!value || !unit){
                return false;
              }

              return {
                value: value,
                unit: unit
              };
            };

            var getTimeObjectFromTimeForm = function(){
              var form = document.getElementById("time-form");
              var hours = parseInt(form.querySelector("[name=hh]").value);
              var minutes = parseInt(form.querySelector("[name=mm]").value);
              var seconds = parseInt(form.querySelector("[name=ss]").value);

              return {
                hours: hours,
                minutes: minutes,
                seconds: seconds
              };
            };

            // Form filling logic

            var fillTimeFormFromTimeObject = function(time){
              var form = document.getElementById("time-form");

              var hoursInput = form.querySelector("input[name=hh]");
              var minutesInput = form.querySelector("input[name=mm]");
              var secondsInput = form.querySelector("input[name=ss]");

              hoursInput.value = time.hours;
              minutesInput.value = time.minutes;
              secondsInput.value = time.seconds;
            };

            var fillDistanceFormFromDistanceObject = function(distance){
              var form = document.getElementById("distance-form");

              var valueInput = form.querySelector("input[name=value]");
              var unitSelectTag = form.querySelector("select");

              valueInput.value = distance.value;
              unitSelectTag.value = distance.unit;
            };

            // Event handlers

            document.getElementById("time-button").addEventListener("click", function(){
              var pace = getPaceObjectFromPaceForm();
              var distance = getDistanceObjectFromDistanceForm();

              if (!pace || !distance){
                alert("Enter pace and distance to calculate time.")
                return;
              }

              var time = calculateTimeFromDistanceAndPace(distance, pace);

              fillTimeFormFromTimeObject(time);
            });

            document.getElementById("distance-button").addEventListener("click", function(){
              var time = getTimeObjectFromTimeForm();
              var pace = getPaceObjectFromPaceForm();

              if (!time || !pace){
                alert("Enter time and pace to calculate distance.")
                return;
              }

              var distance = calculateDistanceFromTimeAndPace(time, pace);

              fillDistanceFormFromDistanceObject(distance);
            });
          </script>
        </div>
      </div>
      <span class="flex"></span>
    </div>
  </template>
  <script>
    Polymer({
      /* this is the element's prototype */
      is: "pace-calc"
    });
  </script>
</dom-module>
